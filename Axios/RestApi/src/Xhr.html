<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button onclick="testGet()">get请求</button>
    <button onclick="testPost()">post请求</button>
    <button onclick="testPut()">put请求</button>
    <button onclick="testDelete()">delete请求</button>
    <script>
      function testGet() {
        axios({
          url: "http://localhost:3000/posts",
          method: "GET",
          params: {
            id: 2,
          },
        }).then(
          (response) => {
            console.log(response);
          },
          (error) => {
            console.log(error.message);
          }
        );
      }
      function testPost() {
        axios({
          url: "http://localhost:3000/posts",
          method: "POST",
          data: {
            title: "json-server1",
            author: "typicode1",
          },
        }).then(
          (response) => {
            console.log(response);
          },
          (error) => {
            console.log(error.message);
          }
        );
      }
      /* 发送put请求 */
      function testPut() {
        axios({
          url: "http://localhost:3000/posts/2",
          method: "PUT",
          data: {
            title: "json-server1==========",
            author: "typicode1============",
          },
        }).then(
          (response) => {
            console.log(response);
          },
          (error) => {
            console.log(error.message);
          }
        );
      }
      /* 发送delete请求 */
      function testDelete() {
        axios({
          url: "http://localhost:3000/posts/2",
          method: "delete",
        }).then(
          (response) => {
            console.log(response);
          },
          (error) => {
            console.log(error.message);
          }
        );
      }
      /* 
            1.函数的返回值为promise,成功的结果为response,异常的结果为error
            2.能处理多种类型的请求：GET/POST/PUT/DELETE
            3.函数的参数为一个配置对象
                {
                    url:'',//请求地址
                    method:'',//请求方式
                    params:{},//GET/DELETE请求的query参数
                    data:{},//POST或DELETE请求的请求体参数
                }
            4.相应json数据，自动解析为js
        
        */
      function axios({ url, method = "GET", params = {}, data = {} }) {

        /* 处理method */
        method=method.toUpperCase()

        /* 返回一个promise对象 */
        return new Promise((resolve, reject) => {

          /* 处理url,拼接params参数 */
          let queryString = "";

          Object.keys(params).forEach((key) => {
            queryString += `${key}=${params[key]}&`;
          });

          if (queryString) {
            queryString = queryString.substring(0, queryString.length - 1);
            url = url + "?" + queryString;
          }

          var xhr = new XMLHttpRequest();

          /* 打开连接（初始化请求，没有请求） */
          xhr.open(method, url);

          /* 发送请求 */
          if (method === "GET" || method === "DELETE") {
            /* send是异步 */
            xhr.send();
          } else if(method === "POST" || method === "PUT") {
            xhr.setRequestHeader(
              "Content-Type",
              "application/json;charset=utf-8"
            );
            xhr.send(JSON.stringify(data));
          }

          /* 绑定状态改变的监听 */
          xhr.onreadystatechange = function () {
            /* 如果请求没有完成，直接结束 */
            if (xhr.readyState !== 4) {
              return;
            }

            /* 如果相应状态码在[200,300)之间代表成功，否则失败 */

            const { status, statusText } = xhr;
            if (status >= 200 && status <= 299) {
              const response = {
                data: JSON.parse(xhr.response),
                status,
                statusText,
              };

              /* 如果成功了，调用resolve */

              resolve(response);
            } else {
              /* 如果失败了，调用reject */
              reject(new Error("request error status is" + status));
            }
          };
        });
      }
    </script>
  </body>
</html>
